# 夜間光データから土地価格を予測 46th Place Solution

## コンテストの概要

### 背景

[公式サイト](https://solafune.com/#/competitions/f03f39cc-597b-4819-b1a5-41479d4b73d6) より引用：

> 電気は人々の日々の生活に欠かせないインフラです。オフィス、商店街、街灯、スーパー、住宅街と生活の至る所に「光」を届けるための電気が行き渡っています。特に夜間は光の量の違いが明確になります。人口が多い都市部では光の量も多く、地方や自然が多い地域では光の量は少なくなります。その特性を利用して、人工衛星から取得可能な夜間光のデータを活用するという取り組みが始まっています。(中略) 今回のコンテストでは夜間光データを元に土地価格を予測するアルゴリズムを開発して頂きます。開発されたアルゴリズムは土地の評価や取引の際に役立てられることを想定しています。

### 入力

22年間 (1992年～2013年) の地域別の夜間光量。

* 年代
* 夜間光量の平均値
* 夜間光量の合計値

### 出力

* 土地の平均価格

### 学習データとテストデータの分割

* 学習データ：1,118地域 (データ数: 21,883。22年分揃っていないデータを含む)
* テストデータ：630地域 (データ数: 13,860)

### 評価指標

* RMSLE

## 解法

土地価格は夜間光量よりも地域に強く依存している (特に、感度を超える光量を放つ高額な地域) と考えられることから、夜間光量の変化から地域特性を掴むことが土地価格を予測する上で重要になる。そこで、22年分の夜間光量を波形データとみなしCNNにかけることで、地域特性に基づく土地価格の予測を試みた。

### 説明変数

* log(夜間光量の平均値 + 1)
* log(夜間光量の合計値 + 1)
* log(メッシュ数 + 1)
    * ※メッシュ数 = 夜間光量の合計値 / 夜間光量の平均値
* 年代

上記の各変数を、全年代・全地域を通して計算した平均と標準偏差をもとに標準化した。

### 目的変数

* log(土地の平均価格 + 1)

### データの選別

学習データは、以下の条件を満たすデータに絞った。

* 22年分のデータが揃っている地域
* メッシュ数を求められる地域 (夜間光量が最低1年以上0より大きな値を取る地域)

### モデル

* 22年分の説明変数を同時に受け取り、22年分の目的変数を同時に出力するCNNを構築した。
* 100個のCNNをバギングした。
* 損失関数はMSE。
* オプティマイザーはAdam。

```
> summary(Model(), (4, 22 ,1))
----------------------------------------------------------------
        Layer (type)               Output Shape         Param #
================================================================
            Conv2d-1            [-1, 64, 22, 1]             832
         Dropout2d-2            [-1, 64, 22, 1]               0
            Conv2d-3            [-1, 64, 22, 1]          12,352
         Dropout2d-4            [-1, 64, 22, 1]               0
            Conv2d-5            [-1, 64, 22, 1]          12,352
         Dropout2d-6            [-1, 64, 22, 1]               0
            Linear-7                  [-1, 128]         180,352
       BatchNorm1d-8                  [-1, 128]             256
           Dropout-9                  [-1, 128]               0
           Linear-10                  [-1, 128]          16,512
      BatchNorm1d-11                  [-1, 128]             256
          Dropout-12                  [-1, 128]               0
           Linear-13                   [-1, 22]           2,838
================================================================
Total params: 225,750
Trainable params: 225,750
Non-trainable params: 0
----------------------------------------------------------------
Input size (MB): 0.00
Forward/backward pass size (MB): 0.07
Params size (MB): 0.86
Estimated Total Size (MB): 0.93
----------------------------------------------------------------
```

### 評価

* バギング時のOOBを利用してRMSEを算出した。

### スコアの推移

| Hash | 概要 | OOB | Public | Private | 最終評価 |
|:--|:--|:-:|:-:|:-:|:-:|
| 80f721e | CNN + バギング10回| 0.624479 | 0.610720 | 0.567011 | - |
| d9dd37e | Conv層にDropoutを追加 | 0.626060 | 0.551442 | 0.525034 | - |
| ca8d2f5 | 説明変数に年代を追加 | 0.529639 | 0.530850 | 0.521360 | - |
| 63cf15e | メッシュ数の欠損を補完 | 0.555430 | 0.552723 | 0.528602 | - |
| 6007cd0 | バギングを10回から100回に変更 | - | - | - | - |
| 1f0180d | Conv層にBatchNormを追加 | 0.543728 | 0.529762 | 0.527637 | x |
| 598327c | Conv層からBatchNormを除去 | 0.551860 | 0.535435 | 0.522648 | x |

## 実行方法

### ビルド

```
docker build . -t pytorch-env
```

### 学習

```
docker run -v ${PWD}:/work -w /work -t pytorch-env python main.py train
```

### 予測

```
docker run -v ${PWD}:/work -w /work -t pytorch-env python main.py predict
```
